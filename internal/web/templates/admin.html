<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="referrer" content="no-referrer">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="{{.Root}}/icon.png">
<title>ç®¡ç†åå° - è¡¨ç™½å¢™</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; background: #f5f5f5; min-height: 100vh; }
  .navbar {
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    padding: 12px 20px;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.07);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 14px auto 0;
    max-width: 920px;
  }
  .navbar h2 { color: #0f172a; font-size: 18px; letter-spacing: 0.2px; }
  .navbar-right { display: flex; align-items: center; gap: 16px; font-size: 13px; }
  .navbar-right .user-chip {
    color: #475569;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 999px;
    padding: 4px 10px;
    font-weight: 600;
  }
  .navbar-right a {
    color: #334155;
    text-decoration: none;
    font-weight: 600;
    background: #ffffff;
    border: 1px solid #dbe5ef;
    border-radius: 8px;
    padding: 6px 12px;
    transition: all 0.2s ease;
  }
  .navbar-right a:hover { background: #f1f5f9; border-color: #cbd5e1; transform: translateY(-1px); }
  .navbar-right a:active { transform: translateY(0); }
  .container { max-width: 900px; margin: 20px auto; padding: 0 16px; }

  /* [æ–°å¢] Qzone é“¾æ¥/çŠ¶æ€æ ·å¼ - å¤ç”¨è‡ª user.html */
  .wall-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 99px;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    margin-right: auto;
    margin-left: 12px;
    transition: all 0.2s ease;
  }
  .wall-badge.online {
    background: #ecfdf5;
    color: #059669;
    border: 1px solid #a7f3d0;
  }
  .wall-badge.online:hover {
    background: #d1fae5;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.15);
  }
  .wall-badge.offline {
    background: #f1f5f9;
    color: #64748b;
    border: 1px solid #e2e8f0;
    cursor: default;
  }
  
  /* çŠ¶æ€æ  */
  .status-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
  .status-bar .badge {
    display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px;
    border-radius: 999px; font-size: 13px; font-weight: 600; cursor: pointer;
    text-decoration: none; transition: all 0.2s ease; border: 1px solid transparent;
    box-shadow: 0 2px 10px rgba(15, 23, 42, 0.05);
    position: relative;
  }
  .status-bar .badge:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(15, 23, 42, 0.09); }
  .status-bar .badge:active { transform: translateY(0); box-shadow: 0 3px 10px rgba(15, 23, 42, 0.16) inset, 0 2px 8px rgba(15, 23, 42, 0.12); }
  .status-bar .badge:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.22), 0 6px 16px rgba(15, 23, 42, 0.1); }
  .status-bar .count {
    min-width: 24px; height: 22px; padding: 0 8px; border-radius: 999px;
    display: inline-flex; align-items: center; justify-content: center; font-size: 12px;
    font-weight: 700; background: rgba(255,255,255,0.75);
  }
  .badge.active { color: #0f172a; border-color: transparent; box-shadow: 0 10px 22px rgba(15, 23, 42, 0.14), 0 2px 7px rgba(15, 23, 42, 0.12); }
  .badge.active .count { background: rgba(255,255,255,0.92); color: #0f172a; }
  .badge.all { background: linear-gradient(135deg, #f8fafc, #eef2f7); color: #334155; border-color: #e2e8f0; }
  .badge.all .count { color: #334155; }
  .badge.all.active { background: linear-gradient(135deg, #cbd5e1, #94a3b8); color: #0f172a; }
  .badge.pending { background: linear-gradient(135deg, #fff7ed, #ffedd5); color: #c2410c; border-color: #fed7aa; }
  .badge.pending .count { color: #c2410c; }
  .badge.pending.active { background: linear-gradient(135deg, #fdba74, #fb923c); color: #7c2d12; }
  .badge.approved { background: linear-gradient(135deg, #f0fdf4, #dcfce7); color: #166534; border-color: #bbf7d0; }
  .badge.approved .count { color: #166534; }
  .badge.approved.active { background: linear-gradient(135deg, #86efac, #4ade80); color: #14532d; }
  .badge.rejected { background: linear-gradient(135deg, #fff5f5, #fee2e2); color: #b91c1c; border-color: #fecaca; }
  .badge.rejected .count { color: #b91c1c; }
  .badge.rejected.active { background: linear-gradient(135deg, #fca5a5, #f87171); color: #7f1d1d; }
  .badge.published { background: linear-gradient(135deg, #eff6ff, #dbeafe); color: #1d4ed8; border-color: #bfdbfe; }
  .badge.published .count { color: #1d4ed8; }
  .badge.published.active { background: linear-gradient(135deg, #93c5fd, #60a5fa); color: #1e3a8a; }

  /* Cookie çŠ¶æ€ */
  .cookie-bar { background: white; padding: 12px 16px; border-radius: 10px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  .cookie-status { font-size: 14px; }
  .cookie-status .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
  .dot.green { background: #22c55e; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
  .dot.red { background: #ef4444; }
  .dot.gray { background: #94a3b8; }
  .btn-sm { padding: 6px 14px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer; }
  .btn-primary { background: #667eea; color: white; }
  .btn-primary:hover { background: #5a6fd6; }

  /* æŠ•ç¨¿å¡ç‰‡ */
  .post-card {
    background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 14px;
    border: 1px solid #e8edf4;
    box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
  }
  .post-card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(15, 23, 42, 0.1); border-color: #dce4ee; }
  .post-card.pending { border-left: 4px solid #fb923c; }
  .post-card.approved { border-left: 4px solid #22c55e; }
  .post-card.rejected, .post-card.failed { border-left: 4px solid #ef4444; }
  .post-card.published { border-left: 4px solid #3b82f6; }
  .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .post-id { font-weight: 700; color: #333; }
  .post-meta { color: #94a3b8; font-size: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 999px; padding: 4px 10px; }
  .post-status { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; margin-left: 8px; }
  .post-status.pending { background: #fff7ed; color: #c2410c; }
  .post-status.approved { background: #f0fdf4; color: #166534; }
  .post-status.rejected { background: #fff5f5; color: #c53030; }
  .post-status.failed { background: #fff5f5; color: #c53030; }
  .post-status.published { background: #eff6ff; color: #1d4ed8; }
  .post-author { color: #64748b; font-size: 13px; margin-bottom: 8px; display: inline-flex; align-items: center; padding: 4px 10px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 999px; }
  .post-text {
    color: #0f172a; font-size: 14px; line-height: 1.75; margin-bottom: 12px; white-space: pre-wrap; word-break: break-word;
    background: #ffffff; border: 1px solid #edf2f7; border-radius: 10px; padding: 10px 12px;
  }
  .post-images { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
  .img-wrap {
    width: 86px; height: 86px; position: relative; border-radius: 10px; overflow: hidden;
    border: 1px solid #e5e7eb; background: #f8fafc;
    box-shadow: 0 3px 10px rgba(15, 23, 42, 0.08);
  }
  .post-images img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; display: block; }
  .img-wrap:hover img { transform: scale(1.06); }
  .post-images img { transition: transform 0.2s ease; }
  .img-fallback { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; text-align: center; padding: 8px; font-size: 11px; color: #64748b; background: linear-gradient(135deg, #eef2ff, #f8fafc); }
  .img-wrap.is-error .img-fallback { display: flex; }
  .img-wrap.is-error img { display: none; }
  .post-actions { display: flex; gap: 8px; }
  .btn-approve { background: #22c55e; color: white; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
  .btn-reject { background: #ef4444; color: white; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
  .btn-approve:hover { background: #16a34a; }
  .btn-reject:hover { background: #dc2626; }
  .empty { text-align: center; padding: 40px; color: #999; font-size: 16px; }

  /* QR Modal */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
  .modal-overlay.show { display: flex; }
  .modal { background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 340px; }
  .modal h3 { margin-bottom: 16px; }
  .modal img { border: 1px solid #eee; border-radius: 8px; }
  .modal .qr-status { margin-top: 12px; font-size: 14px; color: #666; }
  .modal .btn-close { margin-top: 16px; padding: 8px 24px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; }

  .msg { padding: 10px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 14px; }
  .msg.ok { background: #f0fdf4; color: #166534; }
  .batch-bar {
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); padding: 12px 14px; border-radius: 12px; margin-bottom: 12px;
    display: flex; justify-content: space-between; align-items: center; gap: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06); flex-wrap: wrap;
  }
  .batch-left { display: flex; align-items: center; gap: 10px; color: #334155; font-size: 13px; }
  .select-all-wrap {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: #ffffff;
    border: 1px solid #dbe5ef;
    border-radius: 10px;
    font-weight: 600;
    color: #334155;
    cursor: pointer;
    user-select: none;
  }
  .select-all-wrap:hover { border-color: #cbd5e1; background: #f8fafc; }
  .select-all-wrap input[type="checkbox"] { width: 16px; height: 16px; accent-color: #f59e0b; cursor: pointer; }
  #selectedCount {
    color: #1e293b;
    font-weight: 700;
    background: #ecfeff;
    border: 1px solid #bae6fd;
    border-radius: 999px;
    padding: 5px 10px;
  }
  .batch-actions { display: flex; gap: 8px; }
  .btn-batch { border: none; border-radius: 8px; padding: 8px 14px; font-size: 13px; font-weight: 600; cursor: pointer; }
  .btn-batch.approve { background: #16a34a; color: white; }
  .btn-batch.reject { background: #dc2626; color: white; }
  .btn-batch:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.02); }
  .btn-batch:active:not(:disabled) { transform: translateY(0); }
  .btn-batch:disabled { opacity: 0.5; cursor: not-allowed; }
  .post-select { margin-right: 8px; vertical-align: middle; width: 14px; height: 14px; accent-color: #f59e0b; cursor: pointer; }

  @media (max-width: 640px) {
    .navbar {
      margin: 10px 12px 0;
      padding: 10px 12px;
      border-radius: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .navbar-right {
      width: 100%;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .navbar-right a { padding: 5px 10px; }
    .batch-bar { padding: 10px; }
    .batch-left, .batch-actions { width: 100%; }
    .batch-actions button { flex: 1; }
    /* ç§»åŠ¨ç«¯å¾½ç« æ¢è¡Œ */
    .wall-badge {
      order: 3;
      width: 100%;
      justify-content: center;
      margin: 8px 0 0 0;
    }
  }
</style>
</head>
<body>
<div class="navbar">
  <div style="display:flex;align-items:center">
    <h2>ğŸ”§ è¡¨ç™½å¢™ç®¡ç†</h2>
    <span id="wallStatusNav">
      {{if .CookieValid}}
        <a href="https://user.qzone.qq.com/{{.QzoneUIN}}" target="_blank" class="wall-badge online" title="ç‚¹å‡»è®¿é—®è¡¨ç™½å¢™">
          <span class="dot green"></span>
          è¿›å¢™çœ‹çœ‹
        </a>
      {{else}}
        <span class="wall-badge offline" title="ç®¡ç†å‘˜æš‚æœªç™»å½•">
          <span class="dot gray"></span>
          å¢™ä¼‘æ¯ä¸­
        </span>
      {{end}}
    </span>
  </div>

  <div class="navbar-right">
    <span class="user-chip">{{.Account.Username}}</span>
    <a href="{{.Root}}/submit">æŠ•ç¨¿é¡µ</a>
    <a href="{{.Root}}/logout">é€€å‡º</a>
  </div>
</div>
<div class="container">
  {{if .Message}}<div class="msg ok">{{.Message}}</div>{{end}}

  <div class="cookie-bar">
    <div class="cookie-status" id="cookieStatusText">
      {{if .CookieValid}}
        <span class="dot green"></span>QQç©ºé—´å·²ç™»å½• (UIN: {{.QzoneUIN}})
      {{else}}
        <span class="dot red"></span>QQç©ºé—´æœªç™»å½•
      {{end}}
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn-sm btn-primary" onclick="toggleSettings()" id="settingsToggle">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
      <button class="btn-sm btn-primary" onclick="showQRModal()">æ‰«ç ç™»å½•</button>
    </div>
  </div>

  <!-- ç³»ç»Ÿè®¾ç½®é¢æ¿ -->
  <div id="settingsPanel" style="display:none; margin-bottom:16px;">
    <div style="background:white; border-radius:12px; padding:20px; border:1px solid #e2e8f0; box-shadow:0 4px 14px rgba(15,23,42,0.06);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h3 style="font-size:16px; color:#0f172a;">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
        <div style="display:flex; gap:8px;">
          <button class="btn-sm" style="background:#f0f0f0" onclick="loadConfig()">ğŸ”„ é‡æ–°åŠ è½½</button>
          <button class="btn-sm btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
        </div>
      </div>
      <div id="configMsg" style="display:none; padding:8px 12px; border-radius:6px; margin-bottom:12px; font-size:13px;"></div>
      <div id="configForm" style="display:grid; gap:16px;">
        <div style="text-align:center; color:#94a3b8; padding:20px;">åŠ è½½ä¸­...</div>
      </div>
    </div>
  </div>

  <div class="status-bar">
    <a class="badge all {{if eq .StatusFilter ""}}active{{end}}" href="{{.Root}}/admin">
      <span>å…¨éƒ¨</span><span class="count">{{.TotalCount}}</span>
    </a>
    <a class="badge pending {{if eq .StatusFilter "pending"}}active{{end}}" href="{{.Root}}/admin?status=pending">
      <span>å¾…å®¡æ ¸</span><span class="count">{{.PendingCount}}</span>
    </a>
    <a class="badge approved {{if eq .StatusFilter "approved"}}active{{end}}" href="{{.Root}}/admin?status=approved">
      <span>å·²é€šè¿‡</span><span class="count">{{.ApprovedCount}}</span>
    </a>
    <a class="badge rejected {{if eq .StatusFilter "rejected"}}active{{end}}" href="{{.Root}}/admin?status=rejected">
      <span>å·²æ‹’ç»</span><span class="count">{{.RejectedCount}}</span>
    </a>
    <a class="badge published {{if eq .StatusFilter "published"}}active{{end}}" href="{{.Root}}/admin?status=published">
      <span>å·²å‘å¸ƒ</span><span class="count">{{.PublishedCount}}</span>
    </a>
  </div>

  <div class="batch-bar">
    <div class="batch-left">
      <label class="select-all-wrap"><input type="checkbox" id="selectAllPending"> å…¨é€‰å¾…å®¡æ ¸</label>
      <span id="selectedCount">å·²é€‰æ‹© 0 æ¡</span>
    </div>
    <div class="batch-actions">
      <button id="batchApproveBtn" class="btn-batch approve" onclick="batchApprove()" disabled>æ‰¹é‡é€šè¿‡</button>
      <button id="batchRejectBtn" class="btn-batch reject" onclick="batchReject()" disabled>æ‰¹é‡æ‹’ç»</button>
    </div>
  </div>

  {{if .Posts}}
    {{range .Posts}}
    <div class="post-card {{statusClass .Status}}" id="post-{{.ID}}">
      <div class="post-header">
        <div>
          {{if eq (printf "%s" .Status) "pending"}}<input type="checkbox" class="post-select pending-select" value="{{.ID}}" onchange="updateBatchSelection()">{{end}}
          <span class="post-id">#{{.ID}}</span>
          <span class="post-status {{statusClass .Status}}">{{statusText .Status}}</span>
        </div>
        <span class="post-meta">{{formatTime .CreateTime}}</span>
      </div>
      <div class="post-author">
        {{if .Anon}}åŒ¿åç”¨æˆ·{{else}}{{.Name}}{{if .UIN}} ({{.UIN}}){{end}}{{end}}
      </div>
      {{if .Text}}<div class="post-text">{{.Text}}</div>{{end}}
      {{if hasImages .Images}}
      <div class="post-images">
        {{range .Images}}
        <div class="img-wrap">
          <img src="{{.}}" onclick="window.open(this.src)" alt="å›¾ç‰‡" loading="lazy" referrerpolicy="no-referrer" onerror="handleImageError(this)">
          <div class="img-fallback">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
        </div>
        {{end}}
      </div>
      {{end}}
      {{if .Reason}}<div style="color:#999;font-size:13px;margin-bottom:8px">ç†ç”±: {{.Reason}}</div>{{end}}
      {{if eq (printf "%s" .Status) "pending"}}
      <div class="post-actions">
        <button class="btn-approve" onclick="approvePost({{.ID}})">âœ“ é€šè¿‡</button>
        <button class="btn-reject" onclick="rejectPost({{.ID}})">âœ— æ‹’ç»</button>
      </div>
      {{end}}
    </div>
    {{end}}
  {{else}}
    <div class="empty">ğŸ“­ æš‚æ— æŠ•ç¨¿</div>
  {{end}}
</div>

<div class="modal-overlay" id="qrModal">
  <div class="modal">
    <h3>ğŸ“± æ‰«ç ç™»å½•QQç©ºé—´</h3>
    <img id="qrImage" src="" width="200" height="200" style="display:none">
    <div class="qr-status" id="qrStatus">åŠ è½½ä¸­...</div>
    <button class="btn-close" onclick="closeQRModal()">å…³é—­</button>
  </div>
</div>

<script>
async function approvePost(id) {
  if (!confirm('ç¡®è®¤é€šè¿‡ç¨¿ä»¶ #' + id + '?')) return;
  try {
    const resp = await fetch('{{.Root}}/api/approve', {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: 'id=' + id
    });
    const data = await resp.json();
    if (data.ok) {
      location.reload();
    } else {
      alert(data.message);
    }
  } catch(e) { alert('æ“ä½œå¤±è´¥'); }
}

async function rejectPost(id) {
  const reason = prompt('æ‹’ç»ç†ç”±ï¼ˆå¯é€‰ï¼‰:', '');
  if (reason === null) return;
  try {
    const resp = await fetch('{{.Root}}/api/reject', {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: 'id=' + id + '&reason=' + encodeURIComponent(reason)
    });
    const data = await resp.json();
    if (data.ok) {
      location.reload();
    } else {
      alert(data.message);
    }
  } catch(e) { alert('æ“ä½œå¤±è´¥'); }
}

let qrPollTimer = null;

async function refreshCookieStatus() {
  const statusEl = document.getElementById('cookieStatusText');
  const navEl = document.getElementById('wallStatusNav');
  
  try {
    const resp = await fetch('{{.Root}}/api/qzone/status', { cache: 'no-store' });
    if (!resp.ok) return;
    const data = await resp.json();
    if (!data || !data.ok) return;
    
    // æ›´æ–°ä¸­é—´çš„çŠ¶æ€æ¡
    if (statusEl) {
      if (data.cookie_valid) {
        statusEl.innerHTML = '<span class="dot green"></span>QQç©ºé—´å·²ç™»å½• (UIN: ' + data.uin + ')';
      } else {
        statusEl.innerHTML = '<span class="dot red"></span>QQç©ºé—´æœªç™»å½•';
      }
    }

    // æ›´æ–°é¡¶éƒ¨çš„â€œè¿›å¢™â€å¾½ç«  (ä¿æŒä¸ user.html ç±»ä¼¼çš„é€»è¾‘)
    if (navEl) {
      if (data.cookie_valid) {
        // å¦‚æœå·²ç»æ˜¯æ­£ç¡®çŠ¶æ€åˆ™ä¸åˆ·æ–°ï¼Œé¿å…é—ªçƒ
        if (!navEl.querySelector('.wall-badge.online')) {
          navEl.innerHTML = `
            <a href="https://user.qzone.qq.com/${data.uin}" target="_blank" class="wall-badge online" title="ç‚¹å‡»è®¿é—®è¡¨ç™½å¢™">
              <span class="dot green"></span>
              è¿›å¢™çœ‹çœ‹
            </a>`;
        }
      } else {
        if (!navEl.querySelector('.wall-badge.offline')) {
          navEl.innerHTML = `
            <span class="wall-badge offline" title="ç®¡ç†å‘˜æš‚æœªç™»å½•">
              <span class="dot gray"></span>
              å¢™ä¼‘æ¯ä¸­
            </span>`;
        }
      }
    }
  } catch (e) {}
}

function handleImageError(img) {
  const wrapper = img.closest('.img-wrap');
  if (wrapper) {
    wrapper.classList.add('is-error');
  }
}

function getSelectedPostIDs() {
  return Array.from(document.querySelectorAll('.pending-select:checked')).map(el => el.value);
}

function updateBatchSelection() {
  const selected = getSelectedPostIDs();
  const hasSelection = selected.length > 0;
  document.getElementById('selectedCount').textContent = 'å·²é€‰æ‹© ' + selected.length + ' æ¡';
  document.getElementById('batchApproveBtn').disabled = !hasSelection;
  document.getElementById('batchRejectBtn').disabled = !hasSelection;

  const all = Array.from(document.querySelectorAll('.pending-select'));
  const allChecked = all.length > 0 && all.every(el => el.checked);
  document.getElementById('selectAllPending').checked = allChecked;
}

document.getElementById('selectAllPending').addEventListener('change', function() {
  const checked = this.checked;
  document.querySelectorAll('.pending-select').forEach(el => { el.checked = checked; });
  updateBatchSelection();
});

async function batchApprove() {
  const ids = getSelectedPostIDs();
  if (ids.length === 0) return;
  if (!confirm('ç¡®è®¤åˆå¹¶å‘å¸ƒå·²é€‰æ‹©çš„ ' + ids.length + ' æ¡ç¨¿ä»¶å—ï¼Ÿ\n(å°†ç”Ÿæˆé•¿å›¾å¹¶å‘å¸ƒåˆ°QQç©ºé—´)')) return;

  const btn = document.getElementById('batchApproveBtn');
  const originalText = btn.textContent;
  
  // 1. Set Loading State
  btn.disabled = true;
  btn.textContent = 'æ­£åœ¨æ¸²æŸ“å‘å¸ƒ...';
  btn.style.opacity = '0.7';
  btn.style.cursor = 'wait';

  try {
    const resp = await fetch('{{.Root}}/api/approve/batch', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: 'ids=' + encodeURIComponent(ids.join(','))
    });
    
    // Check if response is valid JSON
    const contentType = resp.headers.get("content-type");
    if (!contentType || !contentType.includes("application/json")) {
       throw new Error("Server returned non-JSON response");
    }

    const data = await resp.json();
    
    if (data.ok) {
      alert(data.message || 'å‘å¸ƒæˆåŠŸï¼');
      location.reload();
    } else {
      alert('å¤±è´¥: ' + data.message);
      // Reset button if failed
      btn.disabled = false;
      btn.textContent = originalText;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
    }
  } catch(e) {
    console.error(e);
    alert('è¯·æ±‚å¤±è´¥æˆ–è¶…æ—¶ï¼Œè¯·æ£€æŸ¥åå°æ—¥å¿—');
    btn.disabled = false;
    btn.textContent = originalText;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  }
}

async function batchReject() {
  const ids = getSelectedPostIDs();
  if (ids.length === 0) return;
  const reason = prompt('æ‰¹é‡æ‹’ç»ç†ç”±ï¼ˆå¯é€‰ï¼‰:', '');
  if (reason === null) return;
  try {
    const resp = await fetch('{{.Root}}/api/reject/batch', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: 'ids=' + encodeURIComponent(ids.join(',')) + '&reason=' + encodeURIComponent(reason)
    });
    const data = await resp.json();
    alert(data.message || 'æ“ä½œå®Œæˆ');
    if (data.ok) location.reload();
  } catch(e) {
    alert('æ‰¹é‡æ‹’ç»å¤±è´¥');
  }
}

updateBatchSelection();
refreshCookieStatus();
setInterval(refreshCookieStatus, 2000);

function showQRModal() {
  document.getElementById('qrModal').classList.add('show');
  document.getElementById('qrStatus').textContent = 'æ­£åœ¨è·å–äºŒç»´ç ...';
  document.getElementById('qrImage').style.display = 'none';

  // è¯·æ±‚äºŒç»´ç 
  const img = document.getElementById('qrImage');
  img.src = '{{.Root}}/api/qrcode?' + Date.now();
  img.onload = function() {
    img.style.display = 'block';
    document.getElementById('qrStatus').textContent = 'è¯·ç”¨QQæ‰«æäºŒç»´ç ';
    startQRPoll();
  };
  img.onerror = function() {
    document.getElementById('qrStatus').textContent = 'âŒ è·å–äºŒç»´ç å¤±è´¥';
  };
}

function closeQRModal() {
  document.getElementById('qrModal').classList.remove('show');
  if (qrPollTimer) { clearInterval(qrPollTimer); qrPollTimer = null; }
}

function startQRPoll() {
  if (qrPollTimer) clearInterval(qrPollTimer);
  qrPollTimer = setInterval(async function() {
    try {
      const resp = await fetch('{{.Root}}/api/qrcode/status');
      const data = await resp.json();
      const el = document.getElementById('qrStatus');
      switch(data.status) {
        case 'success':
          el.textContent = 'âœ… ' + data.message;
          clearInterval(qrPollTimer);
          setTimeout(() => location.reload(), 1500);
          break;
        case 'scanned':
          el.textContent = 'ğŸ“± å·²æ‰«ç ï¼Œç­‰å¾…ç¡®è®¤...';
          break;
        case 'expired':
          el.textContent = 'âŒ ' + data.message;
          clearInterval(qrPollTimer);
          break;
        case 'error':
          el.textContent = 'âŒ ' + data.message;
          clearInterval(qrPollTimer);
          break;
      }
    } catch(e) {}
  }, 2000);
}
// â”€â”€â”€ ç³»ç»Ÿè®¾ç½® â”€â”€â”€
let _cfg = null;

function toggleSettings() {
  const panel = document.getElementById('settingsPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    loadConfig();
  } else {
    panel.style.display = 'none';
  }
}

async function loadConfig() {
  const msgEl = document.getElementById('configMsg');
  msgEl.style.display = 'none';
  try {
    const resp = await fetch('{{.Root}}/api/config?reload=true');
    const data = await resp.json();
    if (!data.ok) { showCfgMsg('åŠ è½½å¤±è´¥', false); return; }
    _cfg = data.config;
    renderConfigForm(_cfg);
  } catch(e) {
    showCfgMsg('åŠ è½½é…ç½®å¤±è´¥: ' + e.message, false);
  }
}

async function saveConfig() {
  if (!_cfg) { showCfgMsg('è¯·å…ˆåŠ è½½é…ç½®', false); return; }
  readFormToConfig();
  try {
    const resp = await fetch('{{.Root}}/api/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(_cfg)
    });
    const data = await resp.json();
    showCfgMsg(data.message, data.ok);
    if (data.ok) {
      // ä¿å­˜æˆåŠŸåè‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®
      await loadConfig();
    }
  } catch(e) {
    showCfgMsg('ä¿å­˜å¤±è´¥: ' + e.message, false);
  }
}

function showCfgMsg(text, ok) {
  const el = document.getElementById('configMsg');
  el.style.display = 'block';
  el.textContent = text;
  el.style.background = ok ? '#f0fdf4' : '#fff5f5';
  el.style.color = ok ? '#166534' : '#b91c1c';
}

function renderConfigForm(cfg) {
  const form = document.getElementById('configForm');
  const sectionStyle = 'background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:14px;';
  const titleStyle = 'font-size:14px;font-weight:700;color:#334155;margin-bottom:10px;';
  const rowStyle = 'display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;';
  const labelStyle = 'min-width:120px;font-size:13px;color:#64748b;';
  const inputStyle = 'flex:1;min-width:150px;padding:6px 10px;border:1px solid #dbe5ef;border-radius:6px;font-size:13px;';

  function row(label, id, value, type) {
    type = type || 'text';
    const v = value === undefined || value === null ? '' : value;
    return '<div style="'+rowStyle+'"><label style="'+labelStyle+'">'+label+'</label><input id="cfg_'+id+'" type="'+type+'" value="'+v+'" style="'+inputStyle+'"></div>';
  }

  function section(title, content) {
    return '<div style="'+sectionStyle+'"><div style="'+titleStyle+'">'+title+'</div>'+content+'</div>';
  }

  let html = '';
  // QQç©ºé—´
  html += section('ğŸ”— QQç©ºé—´', 
    row('ä¿æ´»é—´éš”', 'qzone_keep_alive', cfg.qzone.keep_alive) +
    row('æœ€å¤§é‡è¯•', 'qzone_max_retry', cfg.qzone.max_retry, 'number') +
    row('è¶…æ—¶', 'qzone_timeout', cfg.qzone.timeout)
  );
  // Bot
  html += section('ğŸ¤– QQæœºå™¨äºº',
    row('æ˜µç§° (é€—å·åˆ†éš”)', 'bot_nickname', (cfg.bot.zero.nickname||[]).join(',')) +
    row('å‘½ä»¤å‰ç¼€', 'bot_prefix', cfg.bot.zero.command_prefix) +
    row('è¶…çº§ç”¨æˆ· (é€—å·åˆ†éš”)', 'bot_super', (cfg.bot.zero.super_users||[]).join(',')) +
    row('ç®¡ç†ç¾¤å·', 'bot_manage_group', cfg.bot.manage_group, 'number') +
    row('WSåœ°å€', 'bot_ws_url', cfg.bot.ws && cfg.bot.ws[0] ? cfg.bot.ws[0].url : '') +
    row('WS Token', 'bot_ws_token', cfg.bot.ws && cfg.bot.ws[0] ? cfg.bot.ws[0].access_token : '')
  );
  // è¡¨ç™½å¢™
  html += section('ğŸ’Œ è¡¨ç™½å¢™',
    row('ç½²å', 'wall_show_author', cfg.wall.show_author ? '1' : '0') +
    '<div style="font-size:11px;color:#94a3b8;margin:-4px 0 8px 128px;">1=æ˜¾ç¤ºç½²å, 0=ä¸æ˜¾ç¤º</div>' +
    row('é»˜è®¤åŒ¿å', 'wall_anon', cfg.wall.anon_default ? '1' : '0') +
    row('æœ€å¤§å›¾ç‰‡æ•°', 'wall_max_images', cfg.wall.max_images, 'number') +
    row('æœ€å¤§æ–‡å­—é•¿åº¦', 'wall_max_text', cfg.wall.max_text_len, 'number') +
    row('å‘å¸ƒå»¶è¿Ÿ', 'wall_delay', cfg.wall.publish_delay)
  );
  // Web
  html += section('ğŸŒ Web åå°',
    row('ç›‘å¬åœ°å€', 'web_addr', cfg.web.addr)
  );
  // ä¿®æ”¹å¯†ç 
  html += section('ğŸ”‘ ä¿®æ”¹å¯†ç ',
    row('æ—§å¯†ç ', 'pw_old', '', 'password') +
    row('æ–°å¯†ç ', 'pw_new', '', 'password') +
    '<div style="margin-top:8px;text-align:right;"><button class="btn-sm btn-primary" type="button" onclick="changePassword()">ä¿®æ”¹å¯†ç </button></div>'
  );
  // æ•æ„Ÿè¯
  html += section('ğŸš« æ•æ„Ÿè¯',
    row('å¯ç”¨', 'censor_enable', cfg.censor.enable ? '1' : '0') +
    row('æ•æ„Ÿè¯ (é€—å·åˆ†éš”)', 'censor_words', (cfg.censor.words||[]).join(',')) +
    row('è¯åº“æ–‡ä»¶', 'censor_file', cfg.censor.words_file)
  );
  // Worker
  html += section('âš¡ ä»»åŠ¡è°ƒåº¦',
    row('å·¥ä½œåç¨‹æ•°', 'worker_n', cfg.worker.workers, 'number') +
    row('é‡è¯•æ¬¡æ•°', 'worker_retry', cfg.worker.retry_count, 'number') +
    row('é‡è¯•é—´éš”', 'worker_retry_delay', cfg.worker.retry_delay) +
    row('é¢‘ç‡é™åˆ¶', 'worker_rate', cfg.worker.rate_limit) +
    row('è½®è¯¢é—´éš”', 'worker_poll', cfg.worker.poll_interval)
  );
  // æ—¥å¿—
  html += section('ğŸ“‹ æ—¥å¿—',
    row('çº§åˆ«', 'log_level', cfg.log.level)
  );

  form.innerHTML = html;
}

function readFormToConfig() {
  const v = id => (document.getElementById('cfg_'+id)||{}).value || '';
  _cfg.qzone.keep_alive = v('qzone_keep_alive');
  _cfg.qzone.max_retry = parseInt(v('qzone_max_retry')) || 2;
  _cfg.qzone.timeout = v('qzone_timeout');
  _cfg.bot.zero.nickname = v('bot_nickname').split(',').map(s=>s.trim()).filter(Boolean);
  _cfg.bot.zero.command_prefix = v('bot_prefix');
  _cfg.bot.zero.super_users = v('bot_super').split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n));
  _cfg.bot.manage_group = parseInt(v('bot_manage_group')) || 0;
  if (!_cfg.bot.ws || _cfg.bot.ws.length === 0) _cfg.bot.ws = [{}];
  _cfg.bot.ws[0].url = v('bot_ws_url');
  _cfg.bot.ws[0].access_token = v('bot_ws_token');
  _cfg.wall.show_author = v('wall_show_author') === '1';
  _cfg.wall.anon_default = v('wall_anon') === '1';
  _cfg.wall.max_images = parseInt(v('wall_max_images')) || 9;
  _cfg.wall.max_text_len = parseInt(v('wall_max_text')) || 2000;
  _cfg.wall.publish_delay = v('wall_delay');
  _cfg.web.addr = v('web_addr');
  _cfg.censor.enable = v('censor_enable') === '1';
  _cfg.censor.words = v('censor_words').split(',').map(s=>s.trim()).filter(Boolean);
  _cfg.censor.words_file = v('censor_file');
  _cfg.worker.workers = parseInt(v('worker_n')) || 1;
  _cfg.worker.retry_count = parseInt(v('worker_retry')) || 3;
  _cfg.worker.retry_delay = v('worker_retry_delay');
  _cfg.worker.rate_limit = v('worker_rate');
  _cfg.worker.poll_interval = v('worker_poll');
  _cfg.log.level = v('log_level');
}

async function changePassword() {
  const oldPw = (document.getElementById('cfg_pw_old')||{}).value || '';
  const newPw = (document.getElementById('cfg_pw_new')||{}).value || '';
  if (!oldPw || !newPw) { showCfgMsg('è¯·å¡«å†™æ—§å¯†ç å’Œæ–°å¯†ç ', false); return; }
  if (newPw.length < 6) { showCfgMsg('æ–°å¯†ç è‡³å°‘6ä½', false); return; }
  try {
    const resp = await fetch('{{.Root}}/api/change-password', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: 'old_password=' + encodeURIComponent(oldPw) + '&new_password=' + encodeURIComponent(newPw)
    });
    const data = await resp.json();
    showCfgMsg(data.message, data.ok);
    if (data.ok) {
      document.getElementById('cfg_pw_old').value = '';
      document.getElementById('cfg_pw_new').value = '';
    }
  } catch(e) {
    showCfgMsg('ä¿®æ”¹å¯†ç å¤±è´¥: ' + e.message, false);
  }
}
</script>
</body>
</html>